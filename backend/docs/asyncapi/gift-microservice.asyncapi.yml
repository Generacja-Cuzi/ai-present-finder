asyncapi: 3.0.0
id: 'urn:ai-present-finder:gift'
info:
  title: Gift Ideas Microservice AsyncAPI
  version: 2.0.0
  description: |
    AsyncAPI for the gift ideas microservice. Uses RabbitMQ queues.
    This service coordinates gift generation by:
    1. Listening to StalkingCompleted and ChatInterviewCompleted events
    2. Tracking both in a database
    3. When both complete, generating search queries using AI
    4. Emitting fetch events to multiple marketplace services
    5. Emitting context to the reranking service
  license:
    name: MIT
    url: 'https://opensource.org/licenses/MIT'
  tags:
    - name: gift
defaultContentType: application/json
servers:
  rabbitmq:
    host: 'admin:admin@localhost:5672'
    pathname: ''
    protocol: amqp
    description: RabbitMQ broker (env CLOUDAMQP_URL supported)
channels:
  StalkingCompletedEvent:
    address: StalkingCompletedEvent
    messages:
      StalkingCompleted:
        $ref: '#/components/messages/StalkingCompleted'
    description: Queue to receive stalking analysis results.
  ChatInterviewCompletedEvent:
    address: ChatInterviewCompletedEvent
    messages:
      ChatInterviewCompleted:
        $ref: '#/components/messages/ChatInterviewCompleted'
    description: Queue to receive interview completion with user profile.
  GiftContextInitializedEvent:
    address: GiftContextInitializedEvent
    messages:
      GiftContextInitialized:
        $ref: '#/components/messages/GiftContextInitialized'
    description: Queue to send gift context to reranking service.
  FetchOlxEvent:
    address: FetchOlxEvent
    messages:
      FetchOlx:
        $ref: '#/components/messages/FetchOlx'
    description: Queue to request product fetching from OLX.
  FetchAllegroEvent:
    address: FetchAllegroEvent
    messages:
      FetchAllegro:
        $ref: '#/components/messages/FetchAllegro'
    description: Queue to request product fetching from Allegro.
  FetchEbayEvent:
    address: FetchEbayEvent
    messages:
      FetchEbay:
        $ref: '#/components/messages/FetchEbay'
    description: Queue to request product fetching from eBay.
  FetchAmazonEvent:
    address: FetchAmazonEvent
    messages:
      FetchAmazon:
        $ref: '#/components/messages/FetchAmazon'
    description: Queue to request product fetching from Amazon.
operations:
  handleStalkingCompleted:
    action: receive
    channel:
      $ref: '#/channels/StalkingCompletedEvent'
    summary: Process stalking completion and update session state
    messages:
      - $ref: '#/channels/StalkingCompletedEvent/messages/StalkingCompleted'
  handleChatInterviewCompleted:
    action: receive
    channel:
      $ref: '#/channels/ChatInterviewCompletedEvent'
    summary: Process interview completion and update session state
    messages:
      - $ref: '#/channels/ChatInterviewCompletedEvent/messages/ChatInterviewCompleted'
  publishGiftContextInitialized:
    action: send
    channel:
      $ref: '#/channels/GiftContextInitializedEvent'
    summary: Send user profile and keywords for reranking preparation
    messages:
      - $ref: '#/channels/GiftContextInitializedEvent/messages/GiftContextInitialized'
  publishFetchOlx:
    action: send
    channel:
      $ref: '#/channels/FetchOlxEvent'
    summary: Request product search on OLX marketplace
    messages:
      - $ref: '#/channels/FetchOlxEvent/messages/FetchOlx'
  publishFetchAllegro:
    action: send
    channel:
      $ref: '#/channels/FetchAllegroEvent'
    summary: Request product search on Allegro marketplace
    messages:
      - $ref: '#/channels/FetchAllegroEvent/messages/FetchAllegro'
  publishFetchEbay:
    action: send
    channel:
      $ref: '#/channels/FetchEbayEvent'
    summary: Request product search on eBay marketplace
    messages:
      - $ref: '#/channels/FetchEbayEvent/messages/FetchEbay'
  publishFetchAmazon:
    action: send
    channel:
      $ref: '#/channels/FetchAmazonEvent'
    summary: Request product search on Amazon marketplace
    messages:
      - $ref: '#/channels/FetchAmazonEvent/messages/FetchAmazon'
components:
  messages:
    StalkingCompleted:
      name: StalkingCompletedEvent
      title: StalkingCompleted
      summary: Stalking analysis completed with extracted keywords.
      contentType: application/json
      payload:
        type: object
        required:
          - chatId
          - keywords
        properties:
          keywords:
            type: array
            items:
              type: string
            description: Keywords extracted from social media analysis
          chatId:
            type: string
            description: Unique identifier for the chat session
          completedAt:
            type: string
            format: date-time
            description: Timestamp when the stalking analysis was completed
    ChatInterviewCompleted:
      name: ChatInterviewCompletedEvent
      title: ChatInterviewCompleted
      summary: Interview completed with generated user profile.
      contentType: application/json
      payload:
        type: object
        required:
          - chatId
          - profile
        properties:
          chatId:
            type: string
            description: Unique identifier for the chat session
          profile:
            type: object
            description: Profile output from chat interview
            properties:
              recipient_profile:
                type: object
                nullable: true
                description: Structured recipient information
    GiftContextInitialized:
      name: GiftContextInitializedEvent
      title: GiftContextInitialized
      summary: Gift context sent to reranking service for preparation.
      contentType: application/json
      payload:
        type: object
        required:
          - chatId
          - eventId
          - totalEvents
        properties:
          userProfile:
            type: object
            nullable: true
            description: User/recipient profile from interview
          keywords:
            type: array
            items:
              type: string
            description: Keywords from stalking analysis
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events expected
    FetchOlx:
      name: FetchOlxEvent
      title: FetchOlx
      summary: Request to fetch products from OLX.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for OLX
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchAllegro:
      name: FetchAllegroEvent
      title: FetchAllegro
      summary: Request to fetch products from Allegro.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for Allegro
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchEbay:
      name: FetchEbayEvent
      title: FetchEbay
      summary: Request to fetch products from eBay.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for eBay
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchAmazon:
      name: FetchAmazonEvent
      title: FetchAmazon
      summary: Request to fetch products from Amazon.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for Amazon
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          country:
            type: string
            default: PL
            description: Country code for Amazon marketplace
          page:
            type: integer
            default: 1
            description: Page number
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
