asyncapi: 3.0.0
id: 'urn:ai-present-finder:fetch'
info:
  title: Fetch Microservice AsyncAPI
  version: 1.0.0
  description: >
    AsyncAPI for the fetch microservice. Uses RabbitMQ queues.

    This service handles fetching product listings from various marketplace APIs

    (OLX, Allegro, eBay, Amazon) based on search queries generated by the Gift
    Service.

    Each fetch request includes an eventId and totalEvents for coordination with
    the reranking service.

defaultContentType: application/json
servers:
  rabbitmq:
    host: 'admin:admin@localhost:5672'
    pathname: ''
    protocol: amqp
    description: RabbitMQ broker (env CLOUDAMQP_URL supported)
channels:
  FetchOlxEvent:
    address: FetchOlxEvent
    messages:
      FetchOlx:
        $ref: '#/components/messages/FetchOlx'
    description: Queue to receive OLX fetch requests.
  FetchAllegroEvent:
    address: FetchAllegroEvent
    messages:
      FetchAllegro:
        $ref: '#/components/messages/FetchAllegro'
    description: Queue to receive Allegro fetch requests.
  FetchEbayEvent:
    address: FetchEbayEvent
    messages:
      FetchEbay:
        $ref: '#/components/messages/FetchEbay'
    description: Queue to receive eBay fetch requests.
  FetchAmazonEvent:
    address: FetchAmazonEvent
    messages:
      FetchAmazon:
        $ref: '#/components/messages/FetchAmazon'
    description: Queue to receive Amazon fetch requests.
  ProductFetchedEvent:
    address: ProductFetchedEvent
    messages:
      ProductFetched:
        $ref: '#/components/messages/ProductFetched'
    description: Queue to publish fetched products.
operations:
  handleFetchOlx:
    action: receive
    channel:
      $ref: '#/channels/FetchOlxEvent'
    summary: Fetch products from OLX marketplace
    messages:
      - $ref: '#/channels/FetchOlxEvent/messages/FetchOlx'
  handleFetchAllegro:
    action: receive
    channel:
      $ref: '#/channels/FetchAllegroEvent'
    summary: Fetch products from Allegro marketplace
    messages:
      - $ref: '#/channels/FetchAllegroEvent/messages/FetchAllegro'
  handleFetchEbay:
    action: receive
    channel:
      $ref: '#/channels/FetchEbayEvent'
    summary: Fetch products from eBay marketplace
    messages:
      - $ref: '#/channels/FetchEbayEvent/messages/FetchEbay'
  handleFetchAmazon:
    action: receive
    channel:
      $ref: '#/channels/FetchAmazonEvent'
    summary: Fetch products from Amazon marketplace
    messages:
      - $ref: '#/channels/FetchAmazonEvent/messages/FetchAmazon'
  publishProductFetched:
    action: send
    channel:
      $ref: '#/channels/ProductFetchedEvent'
    summary: Send fetched products to reranking service
    messages:
      - $ref: '#/channels/ProductFetchedEvent/messages/ProductFetched'
components:
  messages:
    FetchOlx:
      name: FetchOlxEvent
      title: FetchOlx
      summary: Request to fetch products from OLX.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for OLX
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchAllegro:
      name: FetchAllegroEvent
      title: FetchAllegro
      summary: Request to fetch products from Allegro.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for Allegro
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchEbay:
      name: FetchEbayEvent
      title: FetchEbay
      summary: Request to fetch products from eBay.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for eBay
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    FetchAmazon:
      name: FetchAmazonEvent
      title: FetchAmazon
      summary: Request to fetch products from Amazon.
      contentType: application/json
      payload:
        type: object
        required:
          - query
          - chatId
          - eventId
          - totalEvents
        properties:
          query:
            type: string
            description: Search query for Amazon
          limit:
            type: integer
            default: 20
            description: Maximum number of results
          offset:
            type: integer
            default: 0
            description: Pagination offset
          country:
            type: string
            default: PL
            description: Country code for Amazon marketplace
          page:
            type: integer
            default: 1
            description: Page number
          chatId:
            type: string
            description: Unique identifier for the chat session
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
    ProductFetched:
      name: ProductFetchedEvent
      title: ProductFetched
      summary: Products fetched from a marketplace service.
      contentType: application/json
      payload:
        type: object
        required:
          - chatId
          - provider
          - eventId
          - totalEvents
          - success
        properties:
          products:
            type: array
            items:
              type: object
              properties:
                image:
                  type: string
                  format: uri
                  nullable: true
                  description: Product image URL
                title:
                  type: string
                  description: Product title
                description:
                  type: string
                  description: Product description
                link:
                  type: string
                  format: uri
                  description: Link to product page
                price:
                  type: object
                  nullable: true
                  properties:
                    value:
                      type: number
                      nullable: true
                      description: Numeric price value
                    label:
                      type: string
                      nullable: true
                      description: Formatted price label
                    currency:
                      type: string
                      nullable: true
                      description: 'Currency code (e.g., PLN, USD)'
                    negotiable:
                      type: boolean
                      nullable: true
                      description: Whether price is negotiable
            description: Array of product listings from the marketplace
          chatId:
            type: string
            description: Unique identifier for the chat session
          provider:
            type: string
            enum:
              - allegro
              - amazon
              - ebay
              - olx
            description: Marketplace provider name
          success:
            type: boolean
            description: Whether the fetch operation was successful
          eventId:
            type: string
            description: Unique ID for this batch of fetch requests
          totalEvents:
            type: integer
            description: Total number of fetch events in this batch
